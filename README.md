# EEGNet Matlab Container Template

Template pipleine and docker building instructions for a MATLAB project developed for [EEGNet.org](https://eegnet.org/)

The intention of this template is to provide a starting point, where a developer can replace files and scripts with their own code.

# Building a Sample Pipeline

* Clone down your own version of [EEGLAB](https://github.com/sccn/eeglab/) and install whatever plugins and things you need
  * Presumably, any other processing pipeline could also work
  * To avoid bloat, this template only accepts `.set` files
* Create main pipeline processing function
  * In this case `eeglab_psd_pipeline.m` does all loading, processing, and saving
  * This function should be tested within MATLAB and work smoothly
  * Make sure wherever you are outputting to, the container and your tool will have permissions.
    * You can do `chmod 777 output` for testing purposes
    * More complicated tools that use BIDS may have paths already created
    * Make sure these are you can write to these directories as the container will fail otherwise
  * To test do from within MATLAB do:
    1. `addpath eeglab;`
    2. `eeglab_psd_pipeline('eeglab/sample_data/eeglab_data.set', 'output/test.csv', 100, 200)`
    3. This should make a `test.csv` file
    4. Compare against `output/working_test.csv` as ground truth
* Write command line wrapper
  * This is what external tools will use to interface with the pipeline
  * Allows you to validate fields and informs what to make into boutiques parameters
  * To test do:
    1. `eeglab_psd_cli('eeglab/sample_data/eeglab_data.set', 'output/test.csv', 100, 200)`
    2. This should make a `test.csv` file
    3. Compare against `working_test.csv` as ground truth
  * In this case, it may seem redundant to create wrapper script. Howevever, this is where you can introduce optional parameters, defaults, and more.
* Begin using builtin MATLAB tools to build container
  * Set up application to gather what things are needed for MATLAB to compile:
  * The following command is run inside of the command window:
    ```MATLAB
    appFile = 'eeglab_psd_cli.m';

    buildResults = compiler.build.standaloneApplication(appFile, ...
        'ExecutableName', 'eeglab_psd_app');
    ```
  * Build container via command window in MATLAB:
    ```MATLAB
    compiler.package.docker(buildResults, ...
      'ImageName', 'eeglab-psd-app');
    ```
    * Note that this may take awhile
  * These two build steps should have created two folders: `eeglab-psd-appdocker` and `eeglab_psd_appstandaloneApplication`
  * The resulting Dockerfile generated by MATLAB can be inspected at `eeglab-psd-appdocker/Dockerfile`
* Run final test using docker in a terminal outside of MATLAB:
  ```bash
  docker run --rm \
    -v "$(pwd)/eeglab/sample_data:/data:ro" \
    -v "$(pwd)/output:/out" \
    eeglab-psd-app \
    "/data/eeglab_data.set" "/out/test.csv" 100 200
  ```
  * This should produce the same csv file as all previous steps
